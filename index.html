<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발록 컨텐츠 체크 시스템</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .nickname-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .list-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .reset-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            border-radius: 4px;
        }
        .error-message {
            color: red;
            margin-top: 5px;
        }
        .checked-row {
            background-color: #e8f5e9 !important;
        }
        .job-warrior { color: #c41e3a; }
        .job-thief { color: #fff569; }
        .job-magician { color: #69ccf0; }
        .job-soulmaster { color: #abd473; }
        .job-taoist { color: #f58cba; }
    </style>
</head>
<body>
    <h1>발록 컨텐츠 체크 시스템</h1>
    
    <div class="input-section">
        <div class="nickname-input">
            <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요">
            <select id="jobSelect">
                <option value="warrior">전사</option>
                <option value="thief">도적</option>
                <option value="magician">법사</option>
                <option value="soulmaster">직자</option>
                <option value="taoist">도가</option>
            </select>
            <button id="addButton">추가</button>
        </div>
        <div id="errorMessage" class="error-message"></div>
    </div>
    
    <div class="list-section">
        <h2>닉네임 목록</h2>
        <table id="nicknameTable">
            <thead>
                <tr>
                    <th>닉네임</th>
                    <th>직업</th>
                    <th>발록 컨텐츠 진행</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody id="nicknameList">
                <!-- 닉네임 목록이 여기에 추가됩니다 -->
            </tbody>
        </table>
        
        <div class="reset-info">
            <p>발록 컨텐츠 진행 여부는 매일 자정(00:00)에 초기화됩니다.</p>
            <p>다음 초기화까지 남은 시간: <span id="resetTimer"></span></p>
        </div>
    </div>

    <script>
        // 직업 정보
        const jobInfo = {
            warrior: { name: '전사', class: 'job-warrior' },
            thief: { name: '도적', class: 'job-thief' },
            magician: { name: '법사', class: 'job-magician' },
            soulmaster: { name: '직자', class: 'job-soulmaster' },
            taoist: { name: '도가', class: 'job-taoist' }
        };

        // 로컬 스토리지에서 데이터 안전하게 로드
        let nicknames;
        try {
            nicknames = JSON.parse(localStorage.getItem('nicknames')) || [];
        } catch (e) {
            console.error("로컬 스토리지 파싱 오류:", e);
            nicknames = [];
        }
        
        let lastResetDate = localStorage.getItem('lastResetDate') || new Date().toDateString();
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            renderNicknameList();
            updateResetTimer();
            setInterval(updateResetTimer, 1000);
            checkDailyReset();
            
            // 엔터 키로 추가 가능
            document.getElementById('nicknameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNickname();
            });
            
            // 추가 버튼 이벤트 리스너 (안정화 버전)
            document.getElementById('addButton').addEventListener('click', function() {
                addNickname();
            });
        });
        
        // 닉네임 추가 함수 (문제 해결 버전)
        function addNickname() {
            const nicknameInput = document.getElementById('nicknameInput');
            const jobSelect = document.getElementById('jobSelect');
            const errorMessage = document.getElementById('errorMessage');
            const nickname = nicknameInput.value.trim();
            const job = jobSelect.value;
            
            // 에러 메시지 초기화
            errorMessage.textContent = '';
            
            // 유효성 검사 1: 빈 입력
            if (!nickname) {
                errorMessage.textContent = '닉네임을 입력해주세요.';
                nicknameInput.focus();
                return;
            }
            
            // 유효성 검사 2: 중복 닉네임 (대소문자 구분 없음)
            const isDuplicate = nicknames.some(item => 
                item.name.toLowerCase() === nickname.toLowerCase()
            );
            
            if (isDuplicate) {
                errorMessage.textContent = '이미 존재하는 닉네임입니다.';
                nicknameInput.focus();
                return;
            }
            
            // 새 항목 추가
            nicknames.push({
                name: nickname,
                job: job,
                balrogCompleted: false,
                addedDate: new Date().toISOString()
            });
            
            // 로컬 스토리지 저장
            try {
                localStorage.setItem('nicknames', JSON.stringify(nicknames));
                renderNicknameList();
                nicknameInput.value = '';
                nicknameInput.focus();
            } catch (e) {
                console.error("로컬 스토리지 저장 실패:", e);
                errorMessage.textContent = '저장에 실패했습니다. 브라우저 설정을 확인해주세요.';
            }
        }
        
        // 닉네임 목록 렌더링 (체크된 항목 상단에, 나머지는 직업별 정렬)
        function renderNicknameList() {
            const tbody = document.getElementById('nicknameList');
            tbody.innerHTML = '';
            
            if (nicknames.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 4;
                td.textContent = '등록된 닉네임이 없습니다.';
                td.style.textAlign = 'center';
                td.style.color = '#999';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }
            
            // 체크된 항목과 체크되지 않은 항목 분리
            const checkedItems = nicknames.filter(item => item.balrogCompleted);
            const uncheckedItems = nicknames.filter(item => !item.balrogCompleted);
            
            // 체크되지 않은 항목을 직업별로 정렬
            uncheckedItems.sort((a, b) => {
                const jobOrder = ['warrior', 'thief', 'magician', 'soulmaster', 'taoist'];
                return jobOrder.indexOf(a.job) - jobOrder.indexOf(b.job) || a.name.localeCompare(b.name);
            });
            
            // 체크된 항목 먼저 추가
            checkedItems.forEach((item, index) => {
                addRowToTable(item, true);
            });
            
            // 체크되지 않은 항목 추가
            uncheckedItems.forEach((item, index) => {
                addRowToTable(item, false);
            });
        }
        
        // 테이블에 행 추가 함수
        function addRowToTable(item, isChecked) {
            const tbody = document.getElementById('nicknameList');
            const index = nicknames.findIndex(n => n.name === item.name);
            const tr = document.createElement('tr');
            
            if (isChecked) tr.classList.add('checked-row');
            
            // 닉네임 셀
            const nameTd = document.createElement('td');
            nameTd.textContent = item.name;
            nameTd.classList.add(jobInfo[item.job].class);
            tr.appendChild(nameTd);
            
            // 직업 셀
            const jobTd = document.createElement('td');
            jobTd.textContent = jobInfo[item.job].name;
            jobTd.classList.add(jobInfo[item.job].class);
            tr.appendChild(jobTd);
            
            // 체크박스 셀
            const balrogTd = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.balrogCompleted;
            checkbox.addEventListener('change', function() {
                nicknames[index].balrogCompleted = this.checked;
                localStorage.setItem('nicknames', JSON.stringify(nicknames));
                renderNicknameList(); // 체크 시 재정렬
            });
            balrogTd.appendChild(checkbox);
            tr.appendChild(balrogTd);
            
            // 삭제 버튼 셀
            const actionTd = document.createElement('td');
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '삭제';
            deleteButton.addEventListener('click', function() {
                if (confirm(`'${item.name}'을(를) 삭제하시겠습니까?`)) {
                    nicknames.splice(index, 1);
                    localStorage.setItem('nicknames', JSON.stringify(nicknames));
                    renderNicknameList();
                }
            });
            actionTd.appendChild(deleteButton);
            tr.appendChild(actionTd);
            
            tbody.appendChild(tr);
        }
        
        // 초기화 타이머 업데이트
        function updateResetTimer() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            
            const diff = midnight - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('resetTimer').textContent = 
                `${hours}시간 ${minutes}분 ${seconds}초`;
        }
        
        // 매일 자정에 체크 초기화
        function checkDailyReset() {
            const today = new Date().toDateString();
            
            if (lastResetDate !== today) {
                nicknames = nicknames.map(item => ({
                    ...item,
                    balrogCompleted: false
                }));
                
                lastResetDate = today;
                localStorage.setItem('nicknames', JSON.stringify(nicknames));
                localStorage.setItem('lastResetDate', lastResetDate);
                renderNicknameList();
            }
        }
    </script>
</body>
</html>
